{% assign post = include.post %}
{% assign link_title = include.link_title %}

<article id="post{{ post.id | replace:'/','-' }}" class="page post{% if link_title %} mb6{% endif %}" role="article">
  <header>
    <h1 class="post-title">
      {% if link_title %}<a href="{{ post.url | relative_url }}" class="flip-title">{% endif %}
        {{ post.title }}
      {% if link_title %}</a>{% endif %}
    </h1>

    <p class="post-date">{{ post.date | date: "%Yë…„ %mì›” %dì¼" }}</p>

    {% if post.tags and post.tags.size > 0 %}
    <div class="tags">
      {% for tag in post.tags %}
        <span class="tag">{{ tag }}</span>
      {% endfor %}
    </div>
    {% endif %}

    {% include message.html text=post.description hide=page.hide_description %}
  </header>

  {% unless include.excerpt %}
    <!-- í”Œë¡œíŒ… ëª©ì°¨ - ì§„í–‰ë¥  í‘œì‹œ ìŠ¤íƒ€ì¼ -->
    {% if post.toc != false %}
    <!-- ì§„í–‰ë¥  ë§ -->
    <div class="progress-ring-container" id="progress-ring-container">
      <svg class="progress-ring" width="60" height="60">
        <circle class="progress-ring__circle" stroke="#e6e6e6" stroke-width="3" fill="transparent" r="27" cx="30" cy="30"/>
        <circle class="progress-ring__progress" stroke="url(#gradient)" stroke-width="3" fill="transparent" r="27" cx="30" cy="30"/>
        <defs>
          <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
          </linearGradient>
        </defs>
      </svg>
      <div class="progress-percentage">0%</div>
    </div>

    <!-- í™•ì¥í˜• TOC -->
    <div class="floating-toc modern" id="floating-toc">
      <div class="toc-header">
        <div class="toc-title">ëª©ì°¨</div>
        <button class="toc-close" aria-label="ëª©ì°¨ ë‹«ê¸°">Ã—</button>
      </div>
      <nav id="toc-nav">
        <!-- ëª©ì°¨ëŠ” JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
      </nav>
    </div>

    <!-- ëª¨ë°”ì¼ìš© ëª©ì°¨ í† ê¸€ ë²„íŠ¼ -->
    <button class="toc-toggle" id="toc-toggle" aria-label="ëª©ì°¨ ì—´ê¸°">
      ğŸ“‘
    </button>

    <!-- ëª¨ë°”ì¼ ëª©ì°¨ ì˜¤ë²„ë ˆì´ -->
    <div class="mobile-toc" id="mobile-toc">
      <div class="toc-content">
        <button class="close-btn" id="toc-close" aria-label="ëª©ì°¨ ë‹«ê¸°">âœ•</button>
        <div class="toc-title">ëª©ì°¨</div>
        <nav id="mobile-toc-nav">
          <!-- ëª©ì°¨ëŠ” JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </nav>
      </div>
    </div>

    <script>
      // ëª©ì°¨ ìƒì„± ë° ìŠ¤í¬ë¡¤ í•˜ì´ë¼ì´íŠ¸
      document.addEventListener('DOMContentLoaded', function() {
        const headings = document.querySelectorAll('h2[id], h3[id], h4[id]');
        const tocNav = document.getElementById('toc-nav');
        const mobileTocNav = document.getElementById('mobile-toc-nav');

        // ëª©ì°¨ ìƒì„±
        if (headings.length > 0 && tocNav) {
          const tocList = document.createElement('ul');
          let currentH2List = null;
          let currentH3List = null;

          headings.forEach(heading => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + heading.id;
            a.textContent = heading.textContent;
            li.appendChild(a);

            if (heading.tagName === 'H2') {
              tocList.appendChild(li);
              currentH2List = document.createElement('ul');
              li.appendChild(currentH2List);
              currentH3List = null;
            } else if (heading.tagName === 'H3') {
              if (currentH2List) {
                currentH2List.appendChild(li);
                currentH3List = document.createElement('ul');
                li.appendChild(currentH3List);
              } else {
                tocList.appendChild(li);
              }
            } else if (heading.tagName === 'H4') {
              if (currentH3List) {
                currentH3List.appendChild(li);
              } else if (currentH2List) {
                currentH2List.appendChild(li);
              } else {
                tocList.appendChild(li);
              }
            }
          });

          tocNav.appendChild(tocList);
          if (mobileTocNav) {
            mobileTocNav.appendChild(tocList.cloneNode(true));
          }
        }

        const tocLinks = document.querySelectorAll('.floating-toc a, .mobile-toc a');

        function highlightToc() {
          let current = '';
          headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
              current = heading.id;
            }
          });

          tocLinks.forEach(link => {
            if (link.getAttribute('href') === '#' + current) {
              link.classList.add('active');
            } else {
              link.classList.remove('active');
            }
          });
        }

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë° ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
          const progressRing = document.querySelector('.progress-ring__progress');
          const progressText = document.querySelector('.progress-percentage');

          if (progressRing && progressText) {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrollPercentage = Math.round((scrollTop / scrollHeight) * 100);

            const circumference = 2 * Math.PI * 27; // r=27
            const offset = circumference - (scrollPercentage / 100) * circumference;

            progressRing.style.strokeDashoffset = offset;
            progressText.textContent = scrollPercentage + '%';
          }
        }

        window.addEventListener('scroll', () => {
          highlightToc();
          updateProgress();
        });
        highlightToc();
        updateProgress();

        // ì§„í–‰ë¥  ë§ í´ë¦­ ì‹œ TOC í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
        const progressRingContainer = document.querySelector('.progress-ring-container');
        const floatingToc = document.getElementById('floating-toc');
        const tocCloseBtn = document.querySelector('.toc-close');

        if (progressRingContainer && floatingToc) {
          progressRingContainer.addEventListener('click', function() {
            // í† ê¸€ ê¸°ëŠ¥: ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìˆ¨ê¸°ê³ , ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ í‘œì‹œ
            if (floatingToc.classList.contains('show')) {
              floatingToc.classList.remove('show');
            } else {
              floatingToc.classList.add('show');
            }
          });
        }

        if (tocCloseBtn && floatingToc) {
          tocCloseBtn.addEventListener('click', function() {
            floatingToc.classList.remove('show');
          });
        }

        // ëª¨ë°”ì¼ ëª©ì°¨ í† ê¸€
        const tocToggle = document.getElementById('toc-toggle');
        const mobileToc = document.getElementById('mobile-toc');
        const tocClose = document.getElementById('toc-close');

        if (tocToggle && mobileToc && tocClose) {
          tocToggle.addEventListener('click', function() {
            mobileToc.classList.add('active');
          });

          tocClose.addEventListener('click', function() {
            mobileToc.classList.remove('active');
          });

          mobileToc.addEventListener('click', function(e) {
            if (e.target === mobileToc) {
              mobileToc.classList.remove('active');
            }
          });
        }

        // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });

              // ëª¨ë°”ì¼ ëª©ì°¨ ë‹«ê¸°
              if (mobileToc && mobileToc.classList.contains('active')) {
                mobileToc.classList.remove('active');
              }
            }
          });
        });
      });
    </script>
    {% endif %}

    {{ post.content }}
  {% else %}
    {{ post.excerpt }}
    {% capture post_title %}<a class="heading flip-title" href="{{ post.url | relative_url }}">{{ post.title }}</a>{% endcapture %}
    {% assign text = site.data.strings.continue_reading | default:"Continue reading <!--post_title-->" %}
    <footer>
      <p class="read-more">
        {{ text | replace:"<!--post_title-->", post_title }}
      </p>
    </footer>
  {% endunless %}
</article>
